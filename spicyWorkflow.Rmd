---
title: "Performing a spatial analysis of multiplexed tissue imaging data."
author: "Alexander Nicholls and Ellis Patrick"
date: '2022-07-11'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


```{r}
library(cytomapper)
library(dplyr)
library(ggplot2)
library(simpleSeg)
```

# Read in images

Our images are stored in the `images` folder within the `Data` folder. Here we use `readImages()` from the `EBImage` package to read these into R. If memory is a restricting factor, you could use `loadImages()` from the `cytomapper` package to load all of the tiff images into a `CytoImageList` object, which can store the images as h5 on-disk.


```{r}

pathToImages <- "Data/images"

# Get directories of images
imageDirs <- dir(pathToImages, full.names = TRUE)
names(imageDirs) <- dir(pathToImages, full.names = FALSE)

# Get files in each directory
files <- sapply(imageDirs, list.files, pattern = "tif", full.names = TRUE, simplify = FALSE)

# Read files with readImage from EBImage
images <- lapply(files, readImage, as.is = TRUE)


```


```{r}

# Store images in a CytoImageList with images on_disk as h5 files to save memory. 
dir.create("Data/h5Files")
images <- CytoImageList(images, on_disk = TRUE, h5FilesPath = "Data/h5Files")

mcols(images) <- S4Vectors::DataFrame(ImageNb = names(images))

gc()
```


# Load the clinical data

```{r}

clinical <- read.csv("Data/1-s2.0-S0092867421014860-mmc1.csv")
clinical <- clinical |>
  mutate(imageID = paste0("Point", PointNumber, "_pt", Patient_ID, "_", TMAD_Patient))

clinicalVariables <- c("imageID", "Patient_ID","Status", "Age", "SUBTYPE", "PAM50", "Treatment", "DCIS_grade", "Necrosis")

rownames(clinical) <- clinical$imageID

clinical <- clinical[names(images), ]

```


# Segment the images

```{r}

masks <- simpleSeg(images,
                   nucleus = c("HH3"),
                   cellBody = "dilate",
                   sizeSelection = 10,
                   discSize = 3,
                   cores = 5,
                   tolerance = 0.9, 
                   smooth = 2, 
                   ext = 1,
                   transform = c("maxThresh"))

#display(colorLabels(masks[[1]]))

```


## Visualise separation

```{r}
display(colorLabels(masks[[1]]))

```

## Visualise outlines

```{r}
# img <- CytoImageList(images[1])
# mcols(img) <- S4Vectors::DataFrame(imageID = names(img))
# x = plotPixels(image = normalize(img), mask = masks[1], img_id = "imageID", colour_by = c("CD45", "HH3"), return_images = TRUE)
# display(x$images[[1]])

img <- sqrt(normalize(images[[1]]))*1.5
mask <- masks[[1]]
cells <- rgbImage(blue=img[,,"HH3"], green=img[,,"CD45"])
cells <- paintObjects(mask, cells, col='#ff00ff')
display(cells, all = TRUE)

```


## Check outlying samples



# Summarise cell features.


```{r}
cells <- createCells(masks, images)
colnames(cells) <- c(dimnames(images[[1]])[[3]], "x", "y", "area", "imageID")

cells$imageID <- factor(cells$imageID, labels =  names(masks))
```


# Normalize data


```{r}

  ggplot(cells, aes(x = sqrt(CD3), colour = imageID)) + geom_density() + theme(legend.position = "none")

```
```{r}
cellsNorm <- normalizeCells(cells, markers = dimnames(images[[1]])[[3]], transformation = "asinh", method = c("1stPC"))

 ggplot(cellsNorm, aes(x = sqrt(CD3), colour = imageID)) + geom_density() + theme(legend.position = "none")


```

